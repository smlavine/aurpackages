image: alpine/edge
oauth: git.sr.ht/REPOSITORIES:RW
triggers:
  - action: email
    condition: failure
    to: Sebastian LaVine <mail@smlavine.com>
packages:
  - cmark
  - jq
sources:
  - https://git.sr.ht/~smlavine/aurpackages
tasks:
  # In sr.ht/~smlavine/aurpackages, there are git repositories of AUR
  # packages that I maintain. I don't want to have a README.md in those
  # repositories, because their primary home is on aur.archlinux.org, but I
  # still want to show the project README on their git.sr.ht page. This
  # uploads the README for this repository to those repositories. This
  # GraphQL endpoint expects HTML, so we have to convert it here. Inline in
  # this script are repository IDs for each repository I upload the README to.
  # They are:
  #     ~smlavine/catgirl-aur (72346)
  - convert-md-to-html: |
      set -o pipefail
      cmark aurpackages/README.md | tee README.html
  - generate-query: |
      set -o pipefail
      jq -sR \
          '{
              "query": "mutation UpdateRepo($id: Int!, $readme: String!) {
                  updateRepository(id: $id, input: { readme: $readme}) {
                      id
                  }
              }",
              "variables": {
                  "id": 72346,
                  "readme": .
              }
          }' < README.html | tee query.graphql
  - send-query: |
      acurl -H "Content-Type: application/json" -d@query.graphql \
          https://git.sr.ht/query
